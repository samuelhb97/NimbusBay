{% load custom_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Archivo - {{ username }} - {{ project }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            font-family: Consolas, "Courier New", monospace;
            background-color: #1e1e1e;
            color: #cccccc;
        }
        header {
            height: 50px;
            background-color: #333333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }
        header h1 {
            font-size: 18px;
            margin: 0;
            color: #ffffff;
        }
        footer {
            height: 30px;
            background-color: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border-top: 1px solid #444;
            font-size: 12px;
        }
        main {
            display: flex;
            height: calc(100vh - 80px); /* 50px header + 30px footer */
            overflow: hidden;
        }
        aside {
            flex: 0 0 200px;
            background-color: #252526;
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid #444;
        }
        aside h2 {
            font-size: 16px;
            margin: 0 0 10px;
            color: #ffffff;
        }
        aside a {
            display: block;
            margin-bottom: 5px;
            color: #cccccc;
            text-decoration: none;
            padding: 4px 8px;
            border-radius: 3px;
        }
        aside a:hover {
            background-color: #3e3e42;
        }
        section.content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }
        @media (min-width: 768px) {
            section.content {
                flex-direction: row;
            }
            article.formulario,
            article.log-output {
                flex: 1;
            }
        }
        article.formulario,
        article.log-output {
            background-color: #1e1e1e;
            border: 1px solid #444;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        article.formulario form {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        .CodeMirror {
            flex: 1;
            height: auto;
        }
        .global-button-container {
            padding: 5px;
            border-top: 1px solid #444;
            background-color: #252526;
            text-align: right;
        }
        button {
            padding: 6px 12px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            background-color: #0e639c;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #1177bb;
        }
        #output {
            width: 100%;
            height: 100%;
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: monospace;
            font-size: 13px;
            padding: 8px;
            border: none;
            resize: none;
            outline: none;
        }
        .logs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .image-container {
            text-align: center;
            padding: 5px;
            border-bottom: 1px solid #444;
        }
        #screenshot {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }
        .command-container {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px;
            background-color: #252526;
            border-top: 1px solid #444;
        }
        .command-container input {
            flex: 1;
            padding: 6px;
            border: 1px solid #444;
            border-radius: 3px;
            background-color: #1e1e1e;
            color: #cccccc;
        }
        .command-container button {
            flex-shrink: 0;
        }
        .dir-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 5px;
        }
        .dir-buttons {
        }
        .plus-btn {
            background: transparent;
            border: none;
            color: #cccccc;
            font-size: 16px;
            cursor: pointer;
        }
        .plus-btn:hover {
        }
        .options-menu {
            position: absolute;
            z-index: 9999;
            background-color: #1e1e1e;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .options-menu button {
            font-size: 12px;
            padding: 2px 6px;
            background-color: #555;
            color: #ccc;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
        }
        .options-menu button:hover {
            background-color: #666;
            text-decoration: underline;
        }
        .delete-confirmation {
            margin-top: 5px;
            font-size: 12px;
            color: #f88;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .delete-confirmation button {
            font-size: 12px;
            padding: 2px 6px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .delete-confirmation-overlay {
            position: absolute;
            z-index: 9999;
            background-color: #1e1e1e;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-delete {
            font-size: 12px;
            padding: 2px 6px;
            background-color: #555;
            color: #ccc;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-delete:hover {
            background-color: #666;
        }
        .delete-confirmation button:hover {
            background-color: #555;
        }
        .file-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
        }
        .global-button-container {
            text-align: right;
            padding: 5px;
            background-color: #252526;
            border-top: 1px solid #444;
        }
        .global-button-container button {
            margin-left: 10px;
            padding: 6px 12px;
            background-color: #0e639c;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .global-button-container button:hover {
            background-color: #1177bb;
        }
        .hidden {
            display: none !important;
        }
        header {
            background-color: #333;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #444;
        }
        header .left {
            display: flex;
            align-items: center;
        }
        header .left a {
            text-decoration: none;
            color: #fff;
            margin-right: 15px;
        }
        header .left a:hover {
            text-decoration: underline;
        }
        header .left .nav-links a {
            text-decoration: none;
            color: #fff;
            margin-right: 15px;
            font-size: 16px;
        }
        header .left .nav-links a:hover {
            text-decoration: underline;
        }
        header .right {
            display: flex;
            align-items: center;
        }
        header .right a button,
        header .right button {
            margin-left: 10px;
            padding: 6px 12px;
            background-color: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        header .right a button:hover,
        header .right button:hover {
            text-decoration: underline;
        }
        .file-link.disabled {
            color: #888888;
            cursor: default;
            pointer-events: none;
            text-decoration: none;
        }
    </style>
</head>
<body>
<header>
    <div class="left">
        <a href="{% url 'home' %}">
            <img src="https://storage.googleapis.com/nimbus-static_files/logo_recortado.png" alt="NimbusBay" style="height:40px;">
        </a>
        <div class="nav-links">
            <a href="/features">Características</a>
            <a href="/about">Acerca de</a>
            <a href="/contact">Contacto</a>
        </div>
    </div>
    <div class="right">
        {% if user.is_authenticated %}
            <a href="/coding/lista/{{ user.username }}"><button>Proyectos</button></a>
            <a href="/coding/mensajes"><button>Mensajes</button></a>
            <button id="shareProjectBtn" style="background-color: transparent; border: none; color: #ffffff; cursor: pointer; font-size: 14px;">Compartir</button>
            <form action="{% url 'logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit">Cerrar sesión</button>
            </form>
        {% else %}
            <a href="{% url 'login' %}"><button>Iniciar Sesión</button></a>
            <a href="{% url 'registro' %}"><button>Registrarse</button></a>
        {% endif %}
    </div>
</header>
<div id="shareProjectModal" style="display:none; position: fixed; top:30%; left:30%; background-color: #1e1e1e; border:1px solid #444; padding:20px; border-radius:3px; z-index:1000;">
    <h3 style="color: #ccc; margin-top:0;">Compartir proyecto</h3>
    <p style="color:#ccc;">Ingrese el nombre del usuario con el que desea compartir:</p>
    <input type="text" id="shareRecipient" placeholder="Nombre de usuario" style="width:100%; padding:6px; border:1px solid #444; border-radius:3px; background-color:#252526; color:#ccc;">
    <div style="margin-top:10px; text-align:right;">
        <button id="shareSendBtn" style="background-color:#0e639c; border:none; border-radius:3px; color:#fff; cursor:pointer;">Enviar</button>
        <button id="shareCancelBtn" style="background-color:#555; border:none; border-radius:3px; color:#fff; cursor:pointer;">Cancelar</button>
    </div>
</div>

<!-- Modal de confirmación -->
<main>
    <aside id="sidebar">
        <h2>{{ project }}</h2>
    </aside>
    <section class="content">
        <article class="formulario">
            <form method="post">
                {% csrf_token %}
                <textarea id="documento" name="texto">{{ form.texto.value|escape }}</textarea>
                <div class="global-button-container" id="global-buttons">
                    <button type="submit" id="saveButton">Guardar</button>
                    <button type="submit" id="sendDocument">Ejecutar</button>
                </div>
            </form>
            <div class="button-image" style="padding:5px; background-color:#252526; border-top:1px solid #444; text-align:right;">
                <button id="updateButton">Actualizar imagen</button>
                <button id="closeButton">Cerrar ventanas</button>
            </div>
        </article>
        <article class="log-output">
            <div class="image-container">
                <img id="screenshot" alt="Captura recortada">
            </div>
            <div class="logs-container">
                <textarea id="output"></textarea>
                <div class="command-container">
                    <input type="text" id="command" placeholder="Escribe un comando...">
                    <button id="sendCommand">Enviar</button>
                </div>
            </div>
        </article>
    </section>
</main>
<footer>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>



<script>
    window.read_only = {{ read_only|yesno:"true,false" }};
</script>



<script>

    //URL del contenedor CLoud Run
    const BASE_URL = "terminal-{{ username }}-{{ project }}-131700382768.europe-west1.run.app";

    //Inicialización
     document.addEventListener("DOMContentLoaded", function(){
        initEditor();
        initWebSocket();
        initUIButtons();
        initSidebar();
        initSharingModal();
        initBeforeUnloadHandler();
    });

    function initEditor() {
        const textarea = document.getElementById("documento");
        const initialText = textarea.value;
        window.editor = CodeMirror.fromTextArea(document.getElementById("documento"), {
            lineNumbers: true,
            mode: "python",
            theme: "monokai",
            indentUnit: 4,
            tabSize: 4,
            viewportMargin: Infinity,
            autoCloseBrackets: true,
            matchBrackets: true,
            extraKeys: { "Ctrl-Space": "autocomplete" },
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            readOnly: {% if read_only %}true{% else %}false{% endif %}
        });
        editor.setValue(initialText);
        editor.refresh();
        updateImage();
        toggleGlobalEditorButtons();
    }

    function initWebSocket(){
        const outputArea = document.getElementById('output');
        const commandInput = document.getElementById('command');
        const sendButton = document.getElementById('sendCommand');
        window.outputArea = outputArea;

        const socket = new WebSocket(`wss://${BASE_URL}/ws`);
        window.socket = socket

        //mensajes websocket
        socket.onopen = function(){
            console.log("Conexión abierta");
        };

        socket.onerror = function(error){
            console.error("Error en la comunicación con el contenedor", error);
        };

        socket.onmessage = function(event){
            console.log("Mensaje del websocket:", event.data);
            if (event.data){
                outputArea.value += stripAnsiCodes(event.data) + "\n";
            }
            outputArea.scrollTop = outputArea.scrollHeight;
        };

        socket.onclose = function(event){
            outputArea.value = "La conexión con el contenedor se ha cerrado. Por favor recargue la página"
            try {
                const resp = fetch(`https://${BASE_URL}/`, { cache: "no-store" });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            }catch (err){
                console.error("El contenedor se ha cerrado o ha dejado de funcionar");
                outputArea.value = "El contenedor se ha cerrado por inactividad. Por favor, vuelva a su área de proyectos si quiere seguir trabajando en él"
            }
        }

        //Función enviar texto de la consola por el websocket
        sendButton.onclick = function(){
            const command = commandInput.value;
            if (command.trim()){
                if (command === "cls" || command === "clear") {
                    outputArea.value = "";
                    commandInput.value = "";
                }else{
                    socket.send(JSON.stringify({ command: command }));
                    commandInput.value = "";
                }


            }
        };

        //enviar comando consola con Enter
        commandInput.addEventListener('keydown', function(event){
            if (event.key === "Enter") {
                sendButton.click();
                event.preventDefault();
            }
        });


    }

    function stripAnsiCodes(text) {
        return text.replace(/\x1B\[[0-?]*[ -/]*[@-~]/g, "");
    }


    function initUIButtons() {
        const documentButton = document.getElementById('sendDocument');
        const saveButton = document.getElementById('saveButton');
        window.saveButton = saveButton

        //Función botón de guardado
        saveButton.onclick = function(e){
            e.preventDefault();
            const texto = window.editor.getValue();
            const ruta = window.location.pathname;
            const username = "{{ username }}"
            const project = "{{ project }}"
            fetch(`/coding/guardar-archivo/?texto=${encodeURIComponent(texto)}&ruta=${ruta}&username=${username}&project=${project}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data.mensaje);
                })
                .catch(error => {
                    console.error('Error', error);
                });
        };

        //Función ejecutar archivo actual con el websocket
        documentButton.onclick = function(e){
            e.preventDefault();
            const ruta = window.location.pathname;
            const segmentos = ruta.split('/').filter(segmento => segmento);
            const archivo = segmentos.slice(3).join('/');
            window.outputArea.value = "";
            console.log(archivo);
            saveButton.dispatchEvent(new Event("click"));
            socket.send(JSON.stringify({ command: "python /workdir/" + archivo }));
        };
    }

    function initSidebar() {
        document.getElementById("sidebar").addEventListener("click", function(event) {
            console.log("Estado read_only antes:", window.read_only);
            if (window.read_only === false){
                window.saveButton.click();
            } else {
                window.editor.setOption("readOnly", false);
                window.read_only = false;
                toggleGlobalEditorButtons();
            }
            const target = event.target;
            if (target && target.matches(".file-link")) {
                event.preventDefault();
                let Url = target.getAttribute("data-url");
                console.log("newUrl:", Url);
                let partes = Url.split('/');
                let filePath = partes.slice(4).join('/');
                console.log("filePath:", filePath);
                let fileUrl = "/coding/cargar_archivo/?username={{ username }}&project={{ project }}&path=" + encodeURIComponent(filePath);
                let newUrl = "/coding/{{ username }}/{{ project }}/" + filePath;
                console.log("url buena:", newUrl);
                window.relUrl = newUrl;
                fetch(fileUrl)
                    .then(response => response.text())
                    .then(data => {
                        window.editor.setValue(data);
                        window.editor.refresh();
                        history.pushState({}, "", newUrl);
                        window.dispatchEvent(new PopStateEvent("popstate"));
                    })
                    .catch(error => console.error("Error cargando el archivo", error));
                updateSidebar()
            }

        });

        //Función recoge elementos de la barra lateral
        async function fetchFileList(username, project) {
            try{
                const response = await fetch(`https://${BASE_URL}/list-files?username=${encodeURIComponent(username)}&project=${encodeURIComponent(project)}`);
                if (!response.ok){
                    throw new Error("Error al obtener la lista de archivos");
                }
                const fileList = await response.json();
                return fileList;
            } catch (error) {
                console.error("Error", error);
                return null;
            }
        }
        //Función para actualizar la barra lateral
        function renderSidebar(fileList) {
            const sidebar = document.getElementById("sidebar");
            sidebar.innerHTML = "";

            for (const [path, info] of Object.entries(fileList)) {
                const dirContainer = document.createElement("div");
                dirContainer.classList.add("dir-container");

                if (path === ".") {
                    dirContainer.dataset.fullpath = "/workdir";
                    dirContainer.dataset.isbase = "true";
                } else {
                    dirContainer.dataset.fullpath = `/workdir/${path}`;
                    dirContainer.dataset.isbase = "false";
                }
                dirContainer.dataset.itemname = info.directorio;
                dirContainer.dataset.itemtype = "directory";

                const headerDiv = document.createElement("div");
                headerDiv.classList.add("dir-header");
                let indentLevel = info.nivel;
                if (indentLevel === 0 && path !== ".") {
                    indentLevel = 1;
                }
                headerDiv.style.marginLeft = `${indentLevel * 20}px`;

                const dirName = document.createElement("span");
                dirName.classList.add("dir-name");
                dirName.textContent = info.directorio;
                headerDiv.appendChild(dirName);

                const dirBtnContainer = document.createElement("div");
                dirBtnContainer.classList.add("dir-buttons");
                headerDiv.appendChild(dirBtnContainer);

                dirContainer.appendChild(headerDiv);

                const fileContainer = document.createElement("div");
                fileContainer.classList.add("file-container");
                if (path === ".") {
                    fileContainer.style.marginLeft = "20px";
                } else if (info.nivel === 0) {
                    fileContainer.style.marginLeft = "40px";
                } else {
                    fileContainer.style.marginLeft = `${(info.nivel + 1) * 20}px`;
                }
                info.archivos.forEach(file => {
                    const fileRow = document.createElement("div");
                    fileRow.classList.add("file-row");
                    fileRow.style.display = "flex";
                    fileRow.style.justifyContent = "space-between";
                    fileRow.style.alignItems = "center";

                    // Construir la ruta completa para el archivo usando el directorio padre (parentFullPath)
                    // Para directorios, usamos el dataset.fullpath del contenedor
                    let parentFullPath = (path === ".") ? "/workdir" : `/workdir/${path}`;
                    fileRow.dataset.fullpath = `${parentFullPath}/${file.nombre}`;
                    fileRow.dataset.itemname = file.nombre;
                    fileRow.dataset.itemtype = "file";
                    fileRow.dataset.isbase = "false";

                    if (window.relUrl === undefined) {
                        window.relUrl = window.location.pathname;
                    }

                    if (window.relUrl === file.url) {
                        const span = document.createElement("span");
                        span.textContent = file.nombre;
                        span.classList.add("file-link", "disabled");
                        fileRow.appendChild(span);
                    }else{
                        const link = document.createElement("a");
                        link.href = "#";
                        link.dataset.url = file.url;
                        link.textContent = file.nombre;
                        link.classList.add("file-link");
                        fileRow.appendChild(link);
                    }
                    console.log("relurl: ", window.location.pathname, "fileUrl: ", file.url  )

                    fileContainer.appendChild(fileRow);
                });
                dirContainer.appendChild(fileContainer);
                sidebar.appendChild(dirContainer);
            }
            attachPlusButtons();
        }

        //Función abre menú de opciones para edición de archivos
        function showOptionsMenu(triggerElement, fullPath, itemName, itemType, isBase) {
            const existingMenu = document.querySelector(".options-menu");
            if (existingMenu) existingMenu.remove();

            const menu = document.createElement("div");
            menu.classList.add("options-menu");

            const rect = triggerElement.getBoundingClientRect();
            menu.style.top = rect.top + "px";
            menu.style.left = (rect.right + 5) + "px";

            function createOption(text, onClickHandler) {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (text === "Renombrar") {
                        onClickHandler();
                    } else {
                        onClickHandler();
                        menu.remove();
                        document.removeEventListener("click", outsideClickHandler);
                    }
                };
                menu.appendChild(btn);
            }

            if (itemType === "directory") {
                createOption("Crear nuevo archivo", function() {
                    console.log(`Crear nuevo archivo en ${fullPath}`);
                    showInputForNewItem(triggerElement.closest(".dir-container"), fullPath, "file");
                });
                createOption("Crear nuevo directorio", function() {
                    console.log(`Crear nuevo directorio en ${fullPath}`);
                    showInputForNewItem(triggerElement.closest(".dir-container"), fullPath, "directory");
                });
            }
            if (!isBase) {
                createOption("Renombrar", function() {
                    showRenameInput(triggerElement, fullPath, itemName);
                });
            }
            if (itemType === "directory" && !isBase) {
                createOption("Eliminar directorio", function() {
                    console.log(`Eliminar directorio ${fullPath}`);
                    window.socket.send(JSON.stringify({ command: `rm -rf ${fullPath}` }));
                    setTimeout(updateSidebar, 1000);
                });
            }
            if (itemType === "file") {
                createOption("Eliminar", function() {
                    console.log(`Eliminar archivo ${fullPath}`);
                    window.socket.send(JSON.stringify({ command: `rm ${fullPath}` }));
                    setTimeout(updateSidebar, 1000);
                });
            }

            document.body.appendChild(menu);

            // Función para cerrar el menú si se hace click fuera
            function outsideClickHandler(e) {
                if (!menu.contains(e.target) && e.target !== triggerElement) {
                    menu.remove();
                    document.removeEventListener("click", outsideClickHandler);
                }
            }
            setTimeout(() => {
                document.addEventListener("click", outsideClickHandler);
            }, 0);
        }

        // Función para mostrar el input de renombrado dentro del menú (en lugar de usar prompt)
        function showRenameInput(triggerElement, fullPath, itemName) {
            const menu = document.querySelector(".options-menu");
            if (!menu) return;
            menu.innerHTML = "";

            const label = document.createElement("span");
            label.textContent = "Nuevo nombre:";
            label.style.color = "#ccc";
            menu.appendChild(label);

            const input = document.createElement("input");
            input.type = "text";
            input.value = itemName;
            input.style.display = "block";
            input.style.width = "100%";
            input.style.marginTop = "5px";
            input.style.padding = "4px";
            input.style.border = "1px solid #444";
            input.style.borderRadius = "3px";
            input.style.backgroundColor = "#1e1e1e";
            input.style.color = "#ccc";
            input.style.fontSize = "12px";
            menu.appendChild(input);

            const confirmBtn = document.createElement("button");
            confirmBtn.textContent = "Confirmar";
            confirmBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const newName = input.value.trim();
                if (newName === "") return;
                const lastSlash = fullPath.lastIndexOf("/");
                const parentPath = fullPath.substring(0, lastSlash + 1);
                const newFullPath = parentPath + newName;
                const command = `mv ${fullPath} ${newFullPath}`;
                console.log("Enviando comando de renombrar:", command);
                window.socket.send(JSON.stringify({ command: command }));
                setTimeout(updateSidebar, 1000);
                menu.remove();
                document.removeEventListener("click", outsideClickHandler);
            };
            menu.appendChild(confirmBtn);

            const cancelBtn = document.createElement("button");
            cancelBtn.textContent = "Cancelar";
            cancelBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                menu.remove();
                document.removeEventListener("click", outsideClickHandler);
            };
            menu.appendChild(cancelBtn);

            function outsideClickHandler(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener("click", outsideClickHandler);
                }
            }
            setTimeout(() => {
                document.addEventListener("click", outsideClickHandler);
            }, 0);
        }

        function attachPlusButtons() {
            const rows = document.querySelectorAll(".dir-container, .file-row");
            rows.forEach(row => {

                if (row.classList.contains("file-row") && row.querySelector(".disabled")) {
                    return;
                }
                if (row.querySelector(".plus-btn")) return;
                const plusBtn = document.createElement("button");
                plusBtn.textContent = "+";
                plusBtn.classList.add("plus-btn");
                plusBtn.addEventListener("click", function(e) {
                    e.stopPropagation();
                    const fullPath = row.dataset.fullpath;
                    const itemName = row.dataset.itemname;
                    const itemType = row.dataset.itemtype;
                    const isBase = row.dataset.isbase === "true";
                    showOptionsMenu(this, fullPath, itemName, itemType, isBase);
                });
                if (row.classList.contains("dir-container")) {
                    const headerDiv = row.querySelector(".dir-header");
                    if (headerDiv && !headerDiv.querySelector(".plus-btn")) {
                        headerDiv.appendChild(plusBtn);
                    }
                } else {
                    row.appendChild(plusBtn);
                }
            });
        }

        attachPlusButtons();


        function showInputForNewItem(parentContainer, dirPath, type) {
            if (parentContainer.querySelector(".new-item-input")) return;
            const container = document.createElement("div");
            container.classList.add("new-item-input");
            container.style.marginLeft = "20px";
            container.style.display = "flex";
            container.style.alignItems = "center";
            container.style.marginTop = "5px";

            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = type === "file" ? "Nombre del archivo" : "Nombre del directorio";
            input.style.flex = "1";
            input.style.padding = "4px 6px";
            input.style.border = "1px solid #444";
            input.style.borderRadius = "3px";
            input.style.backgroundColor = "#1e1e1e";
            input.style.color = "#ccc";
            input.style.fontSize = "13px";
            container.appendChild(input);

            input.addEventListener("keydown", function(e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    const name = input.value.trim();
                    if (!name) return;
                    const fullPath = `${dirPath === "." || dirPath === "/workdir"  ? "/workdir/" : dirPath + "/"}${name}`;
                    const command = type === "file" ? `touch "${fullPath}"` : `mkdir "${fullPath}"`;
                    console.log("Enviando comando:", command);
                    window.socket.send(JSON.stringify({ command: command }));
                    setTimeout(updateSidebar, 1000);
                    container.remove();
                }
            });
            parentContainer.appendChild(container);
        }


        async function updateSidebar() {
            const username = "{{ username }}";
            const project = "{{ project }}";
            const fileList = await fetchFileList(username, project);
            if (fileList) {
                renderSidebar(fileList);
            }
        }

        updateSidebar()

    }

    function initSharingModal() {
        const shareProjectBtn = document.getElementById("shareProjectBtn");
        const shareProjectModal = document.getElementById("shareProjectModal");
        const shareRecipientInput = document.getElementById("shareRecipient");
        const shareSendBtn = document.getElementById("shareSendBtn");
        const shareCancelBtn = document.getElementById("shareCancelBtn");


        // Al pulsar "Compartir", mostrar el modal para ingresar destinatario
        shareProjectBtn.addEventListener("click", function () {
            shareRecipientInput.value = "";
            shareProjectModal.style.display = "block";
        });

        // Botón Cancelar en modal de compartir
        shareCancelBtn.addEventListener("click", function () {
            shareProjectModal.style.display = "none";
        });

        // Botón Enviar en modal de compartir
        shareSendBtn.addEventListener("click", async function () {
            const recipient = shareRecipientInput.value.trim();
            if (recipient === "") {
                alert("Por favor, ingrese el nombre de un usuario.");
                return;
            }

            shareProjectModal.style.display = "none";

            try {
                const res = await fetch("/coding/share_project", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: new URLSearchParams({
                        "recipient": recipient,
                        "project": "{{ project }}"
                    })
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }
                const data = await res.json();
                if (data.error) {
                    alert("Error: " + data.error);
                    return;
                }

            } catch (error) {
                console.error("Error enviando la solicitud de compartición:", error);
                alert("Error enviando la solicitud.");
            }
        })
    }

    function initBeforeUnloadHandler() {
        if (window.read_only){
            return;
        }
        const texto = window.editor.getValue();
        const ruta = window.location.pathname;
        const params = new URLSearchParams();
        params.append("texto", texto);
        params.append("ruta", ruta);
        params.append("username", "{{ username }}")
        params.append("project", "{{ project }}")

        navigator.sendBeacon(`/coding/guardar-archivo/`, params);
    }

    window.addEventListener("beforeunload", function (e) {
        initBeforeUnloadHandler();
    });


    window.addEventListener("popstate", function(){
        console.log("Nueva URL: ", window.location.pathname);
    });


    //Función hacer captura del contenedor
    async function updateImage(){
        try {
            const response = await fetch(`https://${BASE_URL}/capture`);
            if (!response.ok){
                throw new Error("Error al obtener la imagen");
            }
            const data = await response.json();
            const base64Image = data.image;
            document.getElementById('screenshot').src = "data:image/png;base64," + base64Image;
        } catch(error) {
            console.error("Error:", error);
        }
    }

        //Función cerrar ventanas gráficas del contenedor
    async function closeWindows(){
        try {
            const response = await fetch(`https://${BASE_URL}/close-windows`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) {
                throw new Error("Error al cerrar las ventanas");
            }
            const data = await response.json();
            console.log('Resultado al cerrar las ventanas:', data);
        } catch (error) {
            console.error("Error al cerrar las ventanas", error);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const updateBtn = document.getElementById("updateButton");

        updateBtn.addEventListener("click", updateImage);

        updateImage();

        setInterval(updateImage, 5000);
    });

        document.getElementById('closeButton').addEventListener('click', closeWindows);

    function toggleGlobalEditorButtons() {
            const editable = (window.read_only === false);
            const saveBtn = document.getElementById("saveButton");
            const sendDocBtn = document.getElementById("sendDocument");
            if (saveBtn) {
                if (editable) {
                    saveBtn.classList.remove("hidden");
                    saveBtn.style.display = "inline-block";
                } else {
                    saveBtn.classList.add("hidden");
                }
            }
            if (sendDocBtn) {
                if (editable) {
                    sendDocBtn.classList.remove("hidden");
                    sendDocBtn.style.display = "inline-block";
                } else {
                    sendDocBtn.classList.add("hidden");
                }
            }
        }

    function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
    }
</script>
</body>
</html>
