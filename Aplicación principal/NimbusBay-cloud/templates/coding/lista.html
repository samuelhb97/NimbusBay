{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Proyectos - {{ username }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Configuración base para ocupar toda la pantalla */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Consolas, "Courier New", monospace;
            background-color: #1e1e1e;
            color: #cccccc;
        }
        /* Contenedor principal */
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }
        /* Header igual al del editor de código */
        header {
            background-color: #333;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #444;
        }
        header h1 {
            font-size: 18px;
            margin: 0;
            color: #ffffff;
        }
        /* Main ocupa el espacio restante */
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        /* Footer fijo al final del contenedor */
        footer {
            height: 30px;
            background-color: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid #444;
            font-size: 12px;
            flex-shrink: 0;
        }
        /* Bloque superior de la lista de proyectos */
        .projects-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .projects-title {
            font-size: 20px;
            font-weight: bold;
            color: #cccccc;
            margin-right: 10px; /* separa del botón */
        }
        .new-project-btn {
            padding: 8px 12px;
            background-color: #0e639c;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .new-project-btn:hover {
            background-color: #1177bb;
        }
        /* Lista de proyectos */
        #projects-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 600px;
        }
        #projects-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
        }
        .project-link {
            display: block;
            text-decoration: none;
            color: #cccccc;
            padding: 8px 12px;
            background-color: #252526;
            border-radius: 3px;
        }
        .project-link:hover {
            background-color: #3e3e42;
        }
        /* Modal de confirmación para cambio de contenedor */
        #modal, #newProjectModal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding: 20px;
            border-radius: 3px;
        }
        /* Modal de confirmación: fondo blanco */
        #modal {
            top: 30%;
            left: 30%;
            width: 350px;
            background-color: #fff;
            border: 1px solid #ccc;
            color: #000;
        }
        #modal p {
            margin-bottom: 10px;
        }
        /* Modal para nuevo proyecto: estilo oscuro */
        #newProjectModal {
            top: 30%;
            left: 30%;
            width: 300px;
            background-color: #1e1e1e;
            border: 1px solid #444;
            color: #cccccc;
        }
        #newProjectModal h3 {
            margin-top: 0;
            color: #ffffff;
        }
        #newProjectModal input {
            width: 100%;
            padding: 6px;
            margin-bottom: 10px;
            border: 1px solid #444;
            border-radius: 3px;
            background-color: #252526;
            color: #cccccc;
        }
        /* Botones en ambos modales */
        #modal button, #newProjectModal button {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            background-color: #0e639c;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }
        #modal button:hover, #newProjectModal button:hover {
            background-color: #1177bb;
        }
        /* Spinner (mensaje de carga) */
        #modal-spinner, #newProjectSpinner {
            display: none;
            margin-bottom: 10px;
        }
        header {
            background-color: #333;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #444;
        }
        header .left {
            display: flex;
            align-items: center;
        }
        header .left a {
            text-decoration: none;
            color: #fff;
            margin-right: 15px;
        }
        header .left a:hover {
            text-decoration: underline;
        }
        header .left .nav-links a {
            text-decoration: none;
            color: #fff;
            margin-right: 15px;
            font-size: 16px;
        }
        header .left .nav-links a:hover {
            text-decoration: underline;
        }
        header .right {
            display: flex;
            align-items: center;
        }
        header .right a button,
        header .right button {
            margin-left: 10px;
            padding: 6px 12px;
            background-color: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        header .right a button:hover,
        header .right button:hover {
            text-decoration: underline;
        }
        .project-name {
            flex-grow: 1;
        }

        /* Botón rojo para eliminar */
        .delete-project-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .project-link {
            width: 500px; /* ancho fijo para el "cuadro" del proyecto */
            font-size: 17px;
            color: #cccccc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="left">
            <a href="{% url 'home' %}">
                <img src="https://storage.googleapis.com/nimbus-static_files/logo_recortado.png" alt="NimbusBay" style="height:40px;">
            </a>
            <div class="nav-links">
                <a href="/features">Características</a>
                <a href="/about">Acerca de</a>
                <a href="/contact">Contacto</a>
            </div>
        </div>
        <div class="right">
            {% if user.is_authenticated %}
                <a href="/coding/lista/{{ user.username }}"><button>Proyectos</button></a>
                <a href="/coding/mensajes"><button>Mensajes</button></a>
                <form action="{% url 'logout' %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit">Cerrar sesión</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}"><button>Iniciar Sesión</button></a>
                <a href="{% url 'registro' %}"><button>Registrarse</button></a>
            {% endif %}
        </div>
    </header>
    <main>
        <div class="projects-header">
            <span class="projects-title">Proyectos de {{ username }}</span>
            <button class="new-project-btn" id="newProjectBtn">Añadir nuevo proyecto</button>
        </div>
        <ul id="projects-list">
            {% for proyecto in archivos %}
                <li>
                    <a href="#" class="project-link" data-project="{{ proyecto.nombre }}">
                        {{ proyecto.nombre }}
                    </a>
                    <button class="delete-project-btn" data-project="{{ proyecto.nombre }}" style="background-color: red; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                        Eliminar
                    </button>
                </li>
            {% endfor %}
        </ul>
    </main>
    <footer>
    </footer>
</div>

<!-- Modal de confirmación para cerrar contenedor -->
<div id="modal">
    <p id="modal-message"></p>
    <div id="modal-spinner">Cargando...</div>
    <button id="modal-yes">Sí</button>
    <button id="modal-no">No</button>
</div>

<!-- Modal para crear nuevo proyecto -->
<div id="newProjectModal">
    <h3>Nuevo Proyecto</h3>
    <input type="text" id="newProjectName" placeholder="Nombre del proyecto">
    <div id="uploadArea" style="border: 2px dashed #555; padding: 10px; margin-top: 10px; text-align: center">
        <p>Arrastre aquí la carpeta de su proyecto en formato .zip</p>
        <input type="file" id="projectFileInput" accept=".zip">
    </div>
    <div id="newProjectSpinner">Guardando...</div>
    <button id="createProjectBtn">Crear</button>
    <button id="cancelProjectBtn">Cancelar</button>
</div>

<script>
    const username = "{{ username }}";


    // Al hacer clic en cada enlace de proyecto
    document.querySelectorAll('.project-link').forEach(link => {
        link.addEventListener('click', async function(e) {
            e.preventDefault();
            const clickedProject = this.dataset.project;
            try {
                const res = await fetch(`/coding/check_container?username=${username}&project=${clickedProject}`);
                const data = await res.json();
                console.log(data);
                console.log(clickedProject)
                console.log(data)
                if (data.error) {
                    alert("Error: " + data.error);
                    return;
                }
                if (!data.exists) {
                    window.location.href = `/coding/preparar_entorno/${username}/${clickedProject}`;
                } else {
                    if (data.container_project === clickedProject) {
                        window.location.href = `/coding/${username}/${clickedProject}`;
                    } else {
                        mostrarModal(data.container_project, clickedProject);
                    }
                }
            } catch (error) {
                alert("Error al comprobar contenedor: " + error);
            }
        });
    });

    // Función para mostrar el modal de confirmación
    function mostrarModal(currentProject, newProject) {
        const modal = document.getElementById('modal');
        const message = document.getElementById('modal-message');
        message.innerText = `Actualmente se está ejecutando un contenedor con el proyecto: ${currentProject}. ¿Quiere cerrarlo para abrir ${newProject} en su lugar?`;
        modal.style.display = 'block';

        document.getElementById('modal-yes').onclick = async function() {
            document.getElementById('modal-spinner').style.display = 'block';
            document.getElementById('modal-message').innerText = `Guardando datos del proyecto: ${currentProject}...`;
                fetch(`/coding/cerrar_contenedor?username=${username}&container_project=${currentProject}`)
                    .then(response => response.json())
                    .then(data => console.log("Cerrar contenedor:", data))
                    .catch(error => console.error("Error cerrando contenedor", error))

                window.location.href = `/coding/preparar_entorno/${username}/${newProject}`;
        };

        document.getElementById('modal-no').onclick = function() {
            modal.style.display = 'none';
        };
    }

    // Manejador para el botón "Añadir nuevo proyecto"
    document.getElementById('newProjectBtn').addEventListener('click', function() {
        document.getElementById('newProjectModal').style.display = 'block';
    });

    document.getElementById('cancelProjectBtn').addEventListener('click', function() {
        document.getElementById('newProjectModal').style.display = 'none';
    });

    function sanitizeProjectName(name) {
        // Convertir a minúsculas
        name = name.toLowerCase();
        // Reemplazar espacios (y cualquier secuencia de espacios) por un guion
        name = name.replace(/\s+/g, '-');
        // Eliminar caracteres que no sean letras, dígitos o guiones
        name = name.replace(/[^a-z0-9\-]/g, '');
        // Eliminar guiones iniciales y finales
        name = name.replace(/^\-+|\-+$/g, '');
        // Si queda vacío, asignar un valor por defecto
        if (name.length === 0) {
            name = "project";
        }
        // Asegurar que comience con una letra
        if (!/^[a-z]/.test(name)) {
            name = 'a' + name;
        }
        // Limitar a 63 caracteres
        if (name.length > 63) {
            name = name.substring(0, 63);
        }
        // Asegurar que no termine con un guion
        if (name.endsWith('-')) {
            name = name.slice(0, -1);
        }
        return name;
    }

    document.getElementById('createProjectBtn').addEventListener('click', async function() {
        const projectName = sanitizeProjectName(document.getElementById('newProjectName').value.trim());

        const fileInput = document.getElementById("projectFileInput");
        const formData = new FormData();
        formData.append("username", username);
        formData.append("project", projectName);

        if (fileInput.files.length > 0) {
            formData.append("project_zip", fileInput.files[0]);
        }else{

        }

        document.getElementById('newProjectSpinner').style.display = 'block';
        try {
            console.log(formData)
            const res = await fetch('/coding/inicializar_proyecto', {
                method: "POST",
                body: formData
            })

            const data = await res.json();
            if (data.error) {
                alert("Error al crear el proyecto: " + data.error);
                document.getElementById('newProjectSpinner').style.display = 'none';
            } else {
                // En lugar de redirigir a preparar-entorno, recargamos la página para que se muestre en la lista
                setTimeout(() => {
                    location.reload();
                }, 3000);
            }
        } catch (error) {
            alert("Error en la operación: " + error);
        }
    });
    const uploadArea = document.getElementById("uploadArea");
    uploadArea.addEventListener("dragover", function(e) {
        e.preventDefault();
        uploadArea.style.backgroundColor = "#333";
    });
    uploadArea.addEventListener("dragleave", function(e) {
        e.preventDefault();
        uploadArea.style.backgroundColor = "";
    });
    uploadArea.addEventListener("drop", function(e) {
        e.preventDefault();
        uploadArea.style.backgroundColor = "";
        const dt = e.dataTransfer;
        if (dt.files.length > 0) {
            document.getElementById("projectFileInput").files = dt.files;
        }
    });

    document.addEventListener("DOMContentLoaded", function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const deleteButtons = document.querySelectorAll(".delete-project-btn");
        deleteButtons.forEach(function(button) {
            button.addEventListener("click", function() {
                console.log("cookie: ",getCookie("csrftoken"))

                // Usamos getAttribute para obtener el valor
                const projectName = this.getAttribute("data-project")
                if (!projectName) {
                    console.error("El nombre del proyecto es undefined");
                    alert("Error: No se encontró el nombre del proyecto.");
                    return;
                }
                if (confirm(`¿Está seguro de que quiere eliminar el proyecto ${projectName}?`)) {
                    fetch(`/coding/eliminar_proyecto/{{ user.username }}/${projectName}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": getCookie("csrftoken")
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.message);
                            } else {
                                alert("Error: " + data.error);
                            }
                        })
                        .catch(error => {
                            console.error("Error al eliminar el proyecto:", error);
                            alert("Error al eliminar el proyecto.");
                        });
                }
            });
        });
    });


</script>
</body>
</html>
